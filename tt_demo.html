<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>React Local</title>
    <script
      type="application/javascript"
      src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"
    ></script>
    <script
      type="application/javascript"
      src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"
    ></script>
    <script
      type="application/javascript"
      src="https://unpkg.com/babel-standalone@6.26.0/babel.js"
    ></script>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div id="root"></div>
    <script src="ws-functions.js"></script>
    <script src="server_address.js"></script>
    <script type="text/javascript">
		
		var currentCard = 0;
		
		function myOnOpen() {
				console.log("myOnOpen");
				doSend("voter"); // notify that this socket wants to get voter data
		}
		
		function onMessage(evt) 
		{
			writeToScreen("Message from server: " + evt.data + '\n');
			var mess_array = evt.data.split("_");
			
			if (mess_array[0]==="card") {
				currentCard = parseInt(mess_array[1]);
			}
		}
		
    </script>
    <script type="text/babel">
      const rootElement = document.getElementById("root");

      class Perfocard extends React.Component {
        constructor(props) {
          super(props);

          this.state = {
            url: "",
            block: 0,
            card: 0,
            data: {},
            submitDisabled: false//true
          };

          this.description = {
            0: "Please pick one value for each parameter. FRQ - sound frequency, AMP - sound amplitude, COL - hue of light, INT - intensity of light",
            1: "Please pick one value for one parameter only. FRQ - sound frequency, AMP - sound amplitude, COL - hue of light, INT - intensity of light",
            2: "Please pick one value for one parameter only. FRQ - sound frequency, AMP - sound amplitude, COL - hue of light, INT - intensity of light",
            3: "Please pick one value for one parameter only. FRQ - sound frequency, AMP - sound amplitude, COL - hue of light, INT - intensity of light"
          };

          this.values = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
          this.params = ["FRQ", "AMP", "COL", "INT"];

          this.renderBlock = this.renderBlock.bind(this);
          this.renderHeader = this.renderHeader.bind(this);
          this.onValueClick = this.onValueClick.bind(this);
          this.submit = this.submit.bind(this);
          this.renderDescriptionBox = this.renderDescriptionBox.bind(this);
          this.renderConnectBtn = this.renderConnectBtn.bind(this);
          
          
          
        }
        
        submit() {
          const { data, block, card } = this.state;
          const { FRQ, AMP, COL, INT } = data[block];
          const sendString = `card_${card}_column_0_${FRQ}_column_1_${AMP}_column_2_${COL}_column_3_${INT}`;

          doSend(sendString);
        }

        componentDidMount() {
          doConnect(serverUrl);
        }

        renderHeader() {
          return (
            <tr className="header row">
              {this.params.map((value, index) => {
                return (
                  <td key={index} className="param">
                    <div class="paramValue">
                      <div>{value}</div>
                    </div>
                  </td>
                );
              })}
            </tr>
          );
        }

        renderBlock() {
          const { data, block } = this.state;
          const currentBlock = data[block];
          const blockFilled =
            currentBlock && Object.keys(currentBlock).length === 4;

          return (
            <table className={blockFilled ? "blockFilled" : ""}>
              {this.renderHeader()}
              {this.values.map((param, i) => {
                return (
                  <tr key={i} className="row">
                    {this.params.map((value, index) => {
                      const touched =
                        currentBlock &&
                        typeof currentBlock[value] === "number" &&
                        currentBlock[value] === i/10;

                      return (
                        <td
                          key={index}
                          className={touched ? "touched" : ""}
                          onClick={() => this.onValueClick(block, value, param)}
                        >
                          <div class="value">
                            <div>{i}</div>
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                );
              })}
            </table>
          );
        }

        onValueClick(block, param, value) {
          this.setState(state => {
            const { data, submitDisabled } = state;
            let disabled = submitDisabled;

            data[block] = {
              ...data[block],
              [param]: value/10
            };

//             if (
//               (block === 0 && Object.keys(data[block]).length === 4) ||
//               ([2, 3, 4].includes(block) && Object.keys(data[block]).length === 1)
//             ) {
//               disabled = false;
//             }

            return {
              data, submitDisabled: disabled
            };
          });
        }

        renderConnectBtn() {
          return (
            <div className="helpers">
              <div className="connectRow">
                <div className="server">Server</div>
                <input
                  className="urlInput"
                  value="ws://192.168.0.114:9009/ws"
                  id="url"
                  type="text"
                />
                <button
                  className="conncet"
                  type="button"
                  id="connectButton"
                  onClick={() => doConnect(serverUrl)}
                >
                  Connect
                </button>
              </div>
              <p>
                <textarea
                  className="output"
                  id="outputtext"
                  rows="5"
                  cols="30"
                  readonly
                ></textarea>
              </p>
            </div>
          );
        }

        renderDescriptionBox() {
          return (
            <div className="description">
              {this.description[this.state.block]}
            </div>
          );
        }

        render() {
          return (
            <div>
              <div className="block">
                {this.renderDescriptionBox()}
                {this.renderBlock()}
                <div className="submit">
                  <button
                    type="button"
                    onClick={this.submit}
                    disabled={this.state.submitDisabled}
                  >
                    Submit
                  </button>
                </div>
              </div>
              {this.renderConnectBtn()}
            </div>
          );
        }
      }

      function App() {
        return (
          <div>
            <Perfocard />
          </div>
        );
      }

      ReactDOM.render(<App />, rootElement);
    </script>
  </body>
</html>
